on: [push]

name: Build Docker images

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: '${{ secrets.DOCKER_PASSWORD }}'
  DOCKER_ORGANIZATION: philipssoftware
  GITHUB_ORGANIZATION: philips-software
  DOCKER_BUILDKIT: 1

jobs:
  build_ort:
    name: ort
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2.3.3
      with:
        submodules: recursive
    - name: Set version
      run: |
        chmod +x bin/check-tracked-repo.sh
        repo=$(bin/check-tracked-repo.sh data/checked-repos.txt ${{env.TARGET_REPO}})
        echo "::set-output name=ORT_VERSION::$(git describe --abbrev=7 --always --tags --dirty)"
    - name: Build Docker Images with Oss Review Toolkit 
      uses: philips-software/docker-ci-scripts@v3.3.1
      with:
        base-dir: latest/ort
        dockerfile: Dockerfile
        image-name: ort
        tags: version-test
        push-branches: version
